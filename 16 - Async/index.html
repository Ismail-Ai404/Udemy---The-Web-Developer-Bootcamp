<!-- @format -->

<!DOCTYPE html>
<html lang="en">
     <head>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width,initial-scale=1" />
          <title>Call Stack & Async Game — Hitman 007 Explains</title>
          <link
               href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap"
               rel="stylesheet"
          />
          <style>
               :root {
                    --bg: #081229;
                    --panel: #0f1b2b;
                    --accent: #ffb86b;
                    --muted: #9fb3c8;
                    --glass: rgba(255, 255, 255, 0.03);
                    --card-radius: 12px;
                    --active: #2a9df4;
               }
               * {
                    box-sizing: border-box;
                    font-family: Inter, system-ui, Segoe UI, Roboto, Arial,
                         sans-serif;
               }
               html,
               body {
                    height: 100%;
                    margin: 0;
                    background: linear-gradient(
                         180deg,
                         #051026 0%,
                         #07142a 60%
                    );
                    color: #dbeaf6;
               }
               .wrap {
                    max-width: 1100px;
                    margin: 20px auto;
                    padding: 18px;
               }

               header {
                    display: flex;
                    align-items: center;
                    gap: 18px;
               }
               h1 {
                    font-size: 20px;
                    margin: 0;
               }
               .subtitle {
                    color: var(--muted);
                    font-size: 13px;
               }

               .layout {
                    display: grid;
                    grid-template-columns: 360px 1fr;
                    gap: 16px;
                    margin-top: 14px;
               }
               .card {
                    background: var(--panel);
                    border-radius: var(--card-radius);
                    padding: 12px;
                    box-shadow: 0 6px 24px rgba(3, 12, 28, 0.55);
               }

               /* Controls */
               .controls {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 8px;
               }
               .controls button {
                    appearance: none;
                    border: 0;
                    background: linear-gradient(90deg, #1167a6, #2a9df4);
                    color: white;
                    padding: 8px 12px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-weight: 700;
               }
               .controls button.ghost {
                    background: transparent;
                    border: 1px solid rgba(255, 255, 255, 0.06);
               }
               .controls button.active {
                    box-shadow: 0 6px 18px rgba(41, 157, 244, 0.18);
                    outline: 2px solid rgba(41, 157, 244, 0.06);
                    transform: translateY(-2px);
               }

               /* Narrator */
               .narrator {
                    display: flex;
                    gap: 12px;
                    align-items: center;
               }
               .avatar {
                    width: 56px;
                    height: 56px;
                    border-radius: 10px;
                    background: linear-gradient(180deg, #000, #0f3944);
                    display: flex;
                    align-items: center;
                    justify-content: center;
               }
               .avatar svg {
                    width: 46px;
                    height: 46px;
               }
               .narrator .text {
                    flex: 1;
               }
               .narrator .hitman {
                    color: var(--accent);
                    font-weight: 800;
               }

               .controlsExtra {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    margin-top: 8px;
               }
               .tiny {
                    font-size: 12px;
                    color: var(--muted);
               }
               .currentTopic {
                    margin-left: auto;
                    padding: 6px 10px;
                    border-radius: 8px;
                    background: linear-gradient(90deg, #072a3a, #0b3f55);
                    font-weight: 700;
                    color: var(--muted);
               }

               /* nicer play + volume */
               .playBtn {
                    background: linear-gradient(90deg, #28c76f, #00b894);
                    border-radius: 8px;
                    padding: 8px 10px;
                    border: 0;
                    color: #021018;
                    font-weight: 800;
                    cursor: pointer;
               }
               .audioControls {
                    display: flex;
                    align-items: center;
                    gap: 8px;
               }
               .volSlider {
                    appearance: none;
                    width: 140px;
                    height: 8px;
                    border-radius: 8px;
                    background: linear-gradient(90deg, #2a9df4, #ffb86b);
                    outline: none;
               }

               /* Visuals */
               .visuals {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-top: 12px;
               }
               .panel {
                    background: linear-gradient(
                         180deg,
                         rgba(255, 255, 255, 0.02),
                         rgba(255, 255, 255, 0.01)
                    );
                    padding: 12px;
                    border-radius: 10px;
                    height: 240px;
                    overflow: auto;
               }
               .panel h3 {
                    margin: 0 0 8px 0;
                    font-size: 14px;
               }
               .stackList,
               .queueList {
                    list-style: none;
                    padding: 8px;
                    margin: 0;
                    min-height: 48px;
               }
               .stackList li,
               .queueList li {
                    padding: 8px;
                    margin: 6px 0;
                    background: var(--glass);
                    border-radius: 8px;
                    font-weight: 700;
                    color: #eaf6ff;
               }
               .slot {
                    opacity: 0.75;
                    font-size: 12px;
                    color: var(--muted);
               }

               .console {
                    background: #051827;
                    padding: 12px;
                    border-radius: 8px;
                    font-family: monospace;
                    font-size: 13px;
                    height: 140px;
                    overflow: auto;
               }

               .codeArea {
                    background: #071a26;
                    border-radius: 8px;
                    padding: 8px;
                    font-family: monospace;
                    font-size: 13px;
                    max-height: 220px;
                    overflow: auto;
               }
               pre {
                    white-space: pre-wrap;
                    margin: 0;
               }
               .codeLine {
                    padding: 6px 8px;
                    border-radius: 6px;
               }
               .codeLine.current {
                    outline: 2px solid rgba(255, 200, 120, 0.12);
                    background: rgba(255, 255, 255, 0.015);
               }

               .examples {
                    display: flex;
                    gap: 8px;
                    margin-top: 10px;
               }
               .examples button {
                    background: linear-gradient(90deg, #ff8b3d, #ffd37a);
                    border: 0;
                    padding: 8px 10px;
                    border-radius: 8px;
                    font-weight: 800;
                    cursor: pointer;
               }

               .cheatsheet {
                    display: block;
                    padding: 12px;
                    border-radius: 8px;
                    background: linear-gradient(
                         180deg,
                         rgba(255, 255, 255, 0.015),
                         transparent
                    );
                    font-size: 13px;
                    color: var(--muted);
               }

               .controlsRow {
                    display: flex;
                    gap: 8px;
                    align-items: center;
                    margin-top: 8px;
               }

               @media (max-width: 980px) {
                    .layout {
                         grid-template-columns: 1fr;
                    }
                    .visuals {
                         grid-template-columns: 1fr;
                    }
               }
          </style>
     </head>
     <body>
          <div class="wrap">
               <header>
                    <div>
                         <h1>Call Stack & Async — Interactive Game</h1>
                         <div class="subtitle">
                              Visual, interactive demos for Call Stack, Web
                              APIs, Callbacks → Promises → async/await
                         </div>
                    </div>
                    <div
                         style="
                              margin-left: auto;
                              display: flex;
                              gap: 10px;
                              align-items: center;
                         "
                    >
                         <div class="tiny">Narrator:</div>
                         <div class="currentTopic" id="currentTopic">
                              Current: —
                         </div>
                    </div>
               </header>

               <div class="layout">
                    <!-- LEFT: controls, narrator, cheatsheet -->
                    <div>
                         <div class="card">
                              <div class="narrator">
                                   <div
                                        class="avatar"
                                        title="Hitman 47 avatar (stylized)"
                                   >
                                        <!-- stylized SVG avatar: not a photo -->
                                        <svg
                                             viewBox="0 0 64 64"
                                             xmlns="http://www.w3.org/2000/svg"
                                             aria-hidden="true"
                                        >
                                             <rect
                                                  x="0"
                                                  y="0"
                                                  width="64"
                                                  height="64"
                                                  rx="8"
                                                  fill="#08111a"
                                             />
                                             <g transform="translate(4,6)">
                                                  <circle
                                                       cx="28"
                                                       cy="16"
                                                       r="12"
                                                       fill="#0b2b2f"
                                                  />
                                                  <rect
                                                       x="18"
                                                       y="22"
                                                       width="20"
                                                       height="18"
                                                       rx="4"
                                                       fill="#071a26"
                                                  />
                                                  <rect
                                                       x="6"
                                                       y="8"
                                                       width="44"
                                                       height="4"
                                                       fill="#08222b"
                                                  />
                                                  <!-- barcode head mark to hint 47 -->
                                                  <rect
                                                       x="22"
                                                       y="8"
                                                       width="2"
                                                       height="6"
                                                       fill="#ffb86b"
                                                  />
                                                  <rect
                                                       x="26"
                                                       y="8"
                                                       width="2"
                                                       height="6"
                                                       fill="#ffb86b"
                                                  />
                                             </g>
                                        </svg>
                                   </div>

                                   <div class="text">
                                        <div class="hitman">
                                             Hitman 47 (Narrator)
                                        </div>
                                        <div id="narration">
                                             Welcome. Click any demo to
                                             visualize how the JavaScript
                                             runtime moves between the Call
                                             Stack, Web APIs, Microtasks and
                                             Tasks. Turn narration ON to hear me
                                             explain each step.
                                        </div>
                                        <div class="controlsExtra">
                                             <label class="tiny">Voice</label>
                                             <select
                                                  id="voiceSelect"
                                                  class="tiny"
                                             ></select>
                                             <label class="tiny"
                                                  ><input
                                                       type="checkbox"
                                                       id="narrationToggle"
                                                       checked
                                                  />
                                                  ON</label
                                             >
                                        </div>

                                        <div class="controlsRow">
                                             <div class="audioControls">
                                                  <button
                                                       id="playNarration"
                                                       class="playBtn"
                                                  >
                                                       ▶ Play
                                                  </button>
                                                  <input
                                                       id="vol"
                                                       class="volSlider"
                                                       type="range"
                                                       min="0"
                                                       max="1"
                                                       step="0.01"
                                                       value="0.9"
                                                  />
                                             </div>

                                             <div
                                                  style="
                                                       margin-left: auto;
                                                       display: flex;
                                                       gap: 8px;
                                                       align-items: center;
                                                  "
                                             >
                                                  <input
                                                       id="externalAudioUrl"
                                                       placeholder="Paste MP3/OGG URL (CORS)"
                                                       style="
                                                            width: 220px;
                                                            padding: 8px;
                                                            border-radius: 8px;
                                                            border: 1px solid
                                                                 rgba(
                                                                      255,
                                                                      255,
                                                                      255,
                                                                      0.04
                                                                 );
                                                            background: transparent;
                                                            color: var(--muted);
                                                       "
                                                  />
                                                  <button
                                                       id="loadExternal"
                                                       class="ghost"
                                                  >
                                                       Load
                                                  </button>
                                                  <label
                                                       class="tiny"
                                                       title="Play external clip instead of TTS"
                                                       ><input
                                                            type="checkbox"
                                                            id="useExternal"
                                                       />
                                                       use external</label
                                                  >
                                             </div>
                                        </div>

                                        <!-- API integration controls -->
                                        <div
                                             style="
                                                  margin-top: 8px;
                                                  display: flex;
                                                  gap: 8px;
                                                  align-items: center;
                                             "
                                        >
                                             <input
                                                  id="ttsApiUrl"
                                                  placeholder="TTS API base URL (optional)"
                                                  style="
                                                       flex: 1;
                                                       padding: 8px;
                                                       border-radius: 8px;
                                                       border: 1px solid
                                                            rgba(
                                                                 255,
                                                                 255,
                                                                 255,
                                                                 0.04
                                                            );
                                                       background: transparent;
                                                       color: var(--muted);
                                                  "
                                             />
                                             <input
                                                  id="ttsApiKey"
                                                  placeholder="API Key (optional)"
                                                  style="
                                                       width: 220px;
                                                       padding: 8px;
                                                       border-radius: 8px;
                                                       border: 1px solid
                                                            rgba(
                                                                 255,
                                                                 255,
                                                                 255,
                                                                 0.04
                                                            );
                                                       background: transparent;
                                                       color: var(--muted);
                                                  "
                                             />
                                             <label class="tiny"
                                                  ><input
                                                       type="checkbox"
                                                       id="useTtsApi"
                                                  />
                                                  use TTS API</label
                                             >
                                        </div>
                                   </div>
                              </div>

                              <hr style="border: none; height: 8px" />

                              <div style="margin-top: 8px" class="controls">
                                   <button
                                        id="cbHellBtn"
                                        data-topic="Callback Hell"
                                   >
                                        🔁 Callback Hell
                                   </button>
                                   <button
                                        id="promBtn"
                                        data-topic="Chained Promises"
                                   >
                                        🔗 Chained Promises
                                   </button>
                                   <button
                                        id="customPromiseBtn"
                                        data-topic="Create Promise"
                                   >
                                        🎁 Create Promise
                                   </button>
                                   <button
                                        id="asyncNoAwaitBtn"
                                        data-topic="async (no await)"
                                   >
                                        ⚡ async (no await)
                                   </button>
                                   <button
                                        id="asyncAwaitBtn"
                                        data-topic="async/await"
                                   >
                                        ⏳ async/await
                                   </button>
                                   <button
                                        id="resetBtn"
                                        class="ghost"
                                        data-topic="Reset"
                                   >
                                        ♻️ Reset
                                   </button>
                              </div>

                              <div style="margin-top: 8px" class="examples">
                                   <button id="ex1">Example 1</button>
                                   <button id="ex2">Example 2</button>
                                   <button id="ex3">Example 3</button>
                              </div>
                         </div>

                         <div style="margin-top: 12px" class="card">
                              <h3 style="margin: 0 0 8px 0">
                                   Mini Cheat-sheet
                              </h3>
                              <div class="cheatsheet" id="cheatsheet">
                                   <strong>Quick facts</strong>
                                   <ul>
                                        <li>
                                             <strong>Call Stack</strong> — where
                                             functions run (LIFO). Top item is
                                             currently executing.
                                        </li>
                                        <li>
                                             <strong>Web APIs</strong> — browser
                                             timers, fetch, DOM events. Work off
                                             the main stack.
                                        </li>
                                        <li>
                                             <strong>Microtask Queue</strong> —
                                             promise .then & queueMicrotask;
                                             processed after current stack,
                                             before macrotasks.
                                        </li>
                                        <li>
                                             <strong
                                                  >Task (macrotask)
                                                  Queue</strong
                                             >
                                             — setTimeout, setInterval, UI
                                             events; processed after microtasks.
                                        </li>
                                   </ul>
                                   <pre>
// innerHTML vs innerText vs textContent
// innerHTML  -> returns/sets HTML inside element (works even if element is display:none)
// innerText  -> returns visible text only (ignores text in display:none)
// textContent-> returns all text content (includes hidden elements)
</pre
                                   >
                              </div>
                         </div>
                    </div>

                    <!-- RIGHT: visuals, console, examples code -->
                    <div>
                         <div class="visuals">
                              <div class="panel card">
                                   <h3>Call Stack</h3>
                                   <ol class="stackList" id="stack"></ol>
                                   <div class="slot">
                                        Top is the currently running function
                                   </div>
                              </div>

                              <div class="panel card">
                                   <h3>Web APIs</h3>
                                   <ul class="queueList" id="webapi"></ul>
                                   <div class="slot">
                                        Simulated timers and asynchronous
                                        runners
                                   </div>
                              </div>

                              <div class="panel card">
                                   <h3>Task Queue (macrotask)</h3>
                                   <ul class="queueList" id="taskQ"></ul>
                                   <div class="slot">
                                        setTimeout callbacks land here
                                   </div>
                              </div>

                              <div class="panel card">
                                   <h3>Microtask Queue</h3>
                                   <ul class="queueList" id="microQ"></ul>
                                   <div class="slot">
                                        Promise .then / queueMicrotask entries —
                                        processed before next macrotask
                                   </div>
                              </div>
                         </div>

                         <div
                              style="display: flex; gap: 12px; margin-top: 12px"
                         >
                              <div style="flex: 1" class="card">
                                   <h3 style="margin: 0 0 6px 0">Console</h3>
                                   <div class="console" id="console"></div>
                                   <div
                                        style="
                                             margin-top: 8px;
                                             font-size: 12px;
                                             color: var(--muted);
                                        "
                                   >
                                        Double-click console for quick facts
                                   </div>
                              </div>

                              <div style="width: 360px" class="card">
                                   <h3 style="margin: 0 0 6px 0">
                                        Example Code
                                   </h3>
                                   <div class="codeArea" id="codeArea"></div>
                                   <div
                                        style="
                                             display: flex;
                                             gap: 8px;
                                             margin-top: 8px;
                                        "
                                   >
                                        <button
                                             id="runCodeBtn"
                                             class="examples"
                                        >
                                             Run
                                        </button>
                                        <button
                                             id="stepCodeBtn"
                                             class="examples"
                                        >
                                             Step
                                        </button>
                                        <button
                                             id="stopCodeBtn"
                                             class="examples ghost"
                                        >
                                             Stop
                                        </button>
                                   </div>
                              </div>
                         </div>
                    </div>
               </div>

               <div
                    style="
                         margin-top: 14px;
                         font-size: 13px;
                         color: var(--muted);
                    "
               >
                    Notes: Narration can use your browser's speech synthesis, an
                    external MP3/OGG URL, or a TTS API (paste base URL + API
                    key). For getvoices.ai you will need to provide their API
                    endpoint and key — paste them in the TTS API fields above.
               </div>
          </div>

          <script>
               /* -------------------- Utilities & UI refs -------------------- */
               const stackEl = document.getElementById("stack");
               const webapiEl = document.getElementById("webapi");
               const taskQEl = document.getElementById("taskQ");
               const microQEl = document.getElementById("microQ");
               const consoleEl = document.getElementById("console");
               const narrationEl = document.getElementById("narration");
               const currentTopicEl = document.getElementById("currentTopic");

               const narrationToggle =
                    document.getElementById("narrationToggle");
               const playNarrationBtn =
                    document.getElementById("playNarration");
               const voiceSelect = document.getElementById("voiceSelect");
               const volSlider = document.getElementById("vol");

               const externalAudioUrlInput =
                    document.getElementById("externalAudioUrl");
               const loadExternalBtn = document.getElementById("loadExternal");
               const useExternalCheckbox =
                    document.getElementById("useExternal");

               const ttsApiUrlInput = document.getElementById("ttsApiUrl");
               const ttsApiKeyInput = document.getElementById("ttsApiKey");
               const useTtsApiCheckbox = document.getElementById("useTtsApi");

               const demoButtons = Array.from(
                    document.querySelectorAll(".controls button")
               );
               const ex1 = document.getElementById("ex1");
               const ex2 = document.getElementById("ex2");
               const ex3 = document.getElementById("ex3");

               const codeArea = document.getElementById("codeArea");
               const runCodeBtn = document.getElementById("runCodeBtn");
               const stepCodeBtn = document.getElementById("stepCodeBtn");
               const stopCodeBtn = document.getElementById("stopCodeBtn");

               let activeButton = null;
               let activeTopic = null;

               let externalAudio = null; // HTMLAudioElement when loaded
               let useExternal = false;

               /* -------------------- Speech setup -------------------- */
               function populateVoices() {
                    try {
                         const synth = window.speechSynthesis;
                         const voices = synth.getVoices();
                         voiceSelect.innerHTML = "";
                         voices.forEach((v) => {
                              const opt = document.createElement("option");
                              opt.value = v.name;
                              opt.textContent = `${v.name} (${v.lang})`;
                              voiceSelect.appendChild(opt);
                         });
                    } catch (e) {
                         /* ignore */
                    }
               }
               populateVoices();
               if (typeof speechSynthesis !== "undefined")
                    speechSynthesis.onvoiceschanged = populateVoices;

               async function callTtsApiFetch(text) {
                    // Generic TTS fetch helper. The exact request shape depends on provider.
                    // User must provide a working TTS API base URL and key (for getvoices.ai, paste the endpoint they provide).
                    const base = ttsApiUrlInput.value.trim();
                    const key = ttsApiKeyInput.value.trim();
                    if (!base) throw new Error("No TTS API base URL provided");

                    // Try a conservative POST pattern that many TTS APIs accept: JSON { text }
                    const url = base.replace(/\/$/, "") + "/synthesize";
                    const res = await fetch(url, {
                         method: "POST",
                         headers: {
                              "Content-Type": "application/json",
                              ...(key
                                   ? { Authorization: "Bearer " + key }
                                   : {}),
                         },
                         body: JSON.stringify({ text }),
                    });
                    if (!res.ok)
                         throw new Error(
                              "TTS API error: " +
                                   res.status +
                                   " " +
                                   res.statusText
                         );
                    const blob = await res.blob();
                    return URL.createObjectURL(blob);
               }

               async function speak(text) {
                    if (!narrationToggle.checked) return;

                    // 1) If user chose a TTS API and provided info, try it first
                    if (
                         useTtsApiCheckbox.checked &&
                         ttsApiUrlInput.value.trim()
                    ) {
                         try {
                              const audioUrl = await callTtsApiFetch(text);
                              const a = new Audio(audioUrl);
                              a.volume = parseFloat(volSlider.value) || 0.9;
                              await a.play();
                              return;
                         } catch (e) {
                              log("TTS API failed:", e.message);
                              // fallthrough to other options
                         }
                    }

                    // 2) If user provided an external audio clip to play
                    if (useExternal && externalAudio) {
                         try {
                              externalAudio.currentTime = 0;
                              externalAudio.volume =
                                   parseFloat(volSlider.value) || 0.9;
                              await externalAudio.play();
                              return;
                         } catch (e) {
                              log("External audio play error:", e.message);
                         }
                    }

                    // 3) Fallback to built-in Web Speech API
                    if (!("speechSynthesis" in window)) return;
                    const utter = new SpeechSynthesisUtterance(text);
                    const vs = voiceSelect.value;
                    if (vs) {
                         const v = speechSynthesis
                              .getVoices()
                              .find((x) => x.name === vs);
                         if (v) utter.voice = v;
                    }
                    utter.volume = parseFloat(volSlider.value) || 0.9;
                    speechSynthesis.cancel();
                    speechSynthesis.speak(utter);
               }

               playNarrationBtn.addEventListener("click", () =>
                    speak(narrationEl.textContent)
               );

               loadExternalBtn.addEventListener("click", async () => {
                    const url = externalAudioUrlInput.value.trim();
                    if (!url) {
                         alert("Paste an MP3/OGG URL first");
                         return;
                    }
                    log("Loading external audio...");
                    try {
                         const res = await fetch(url, { mode: "cors" });
                         if (!res.ok)
                              throw new Error(
                                   "Network response not ok: " + res.status
                              );
                         const blob = await res.blob();
                         const audioUrl = URL.createObjectURL(blob);
                         externalAudio = new Audio(audioUrl);
                         externalAudio.crossOrigin = "anonymous";
                         log(
                              "External audio loaded. Check CORS if playback fails."
                         );
                    } catch (e) {
                         log("Failed to load external audio:", e.message);
                         alert(
                              "Failed to load audio. CORS or network may block it. See console."
                         );
                    }
               });

               useExternalCheckbox.addEventListener("change", (e) => {
                    useExternal = e.target.checked;
                    log("Use external audio:", useExternal);
               });

               /* -------------------- Visualization state -------------------- */
               let STACK = [];
               let WEBAPIS = [];
               let TASKQ = [];
               let MICROQ = [];

               function render() {
                    stackEl.innerHTML = "";
                    if (STACK.length === 0)
                         stackEl.innerHTML =
                              '<li style="opacity:.5">(empty)</li>';
                    else
                         for (let i = STACK.length - 1; i >= 0; i--) {
                              const li = document.createElement("li");
                              li.textContent = STACK[i];
                              li.classList.add("pulse");
                              stackEl.appendChild(li);
                         }

                    const fill = (el, arr) => {
                         el.innerHTML = "";
                         if (arr.length === 0)
                              el.innerHTML =
                                   '<li style="opacity:.5">(empty)</li>';
                         else
                              arr.forEach((it) => {
                                   const li = document.createElement("li");
                                   li.textContent = it;
                                   el.appendChild(li);
                              });
                    };
                    fill(webapiEl, WEBAPIS);
                    fill(taskQEl, TASKQ);
                    fill(microQEl, MICROQ);
               }

               function log(...args) {
                    const line = document.createElement("div");
                    line.textContent = args.join(" ");
                    consoleEl.appendChild(line);
                    consoleEl.scrollTop = consoleEl.scrollHeight;
               }

               function pushStack(name) {
                    STACK.push(name);
                    render();
               }
               function popStack() {
                    STACK.pop();
                    render();
               }
               function addWebAPI(name) {
                    WEBAPIS.push(name);
                    render();
               }
               function removeWebAPI(name) {
                    const i = WEBAPIS.indexOf(name);
                    if (i >= 0) WEBAPIS.splice(i, 1);
                    render();
               }
               function enqueueTask(name) {
                    TASKQ.push(name);
                    render();
               }
               function dequeueTask() {
                    const n = TASKQ.shift();
                    render();
                    return n;
               }
               function enqueueMicro(name) {
                    MICROQ.push(name);
                    render();
               }
               function dequeueMicro() {
                    const n = MICROQ.shift();
                    render();
                    return n;
               }

               function reset(loggable = true) {
                    STACK = [];
                    WEBAPIS = [];
                    TASKQ = [];
                    MICROQ = [];
                    render();
                    consoleEl.innerHTML = "";
                    if (loggable) log("--- Reset ---");
               }
               reset(false);

               /* -------------------- Active topic UI -------------------- */
               function setActiveButton(btn) {
                    demoButtons.forEach((b) => b.classList.remove("active"));
                    if (btn) btn.classList.add("active");
                    activeButton = btn;
                    activeTopic = btn ? btn.dataset.topic : null;
                    currentTopicEl.textContent =
                         "Current: " + (activeTopic || "—");
                    if (activeTopic) {
                         log("Selected topic:", activeTopic);
                         speak(activeTopic + " selected.");
                    }
                    // populate code steps for the topic
                    populateCodeForTopic(activeTopic);
               }

               document
                    .getElementById("cbHellBtn")
                    .addEventListener("click", (e) => {
                         reset(true);
                         setActiveButton(e.currentTarget);
                    });
               document
                    .getElementById("promBtn")
                    .addEventListener("click", (e) => {
                         reset(true);
                         setActiveButton(e.currentTarget);
                    });
               document
                    .getElementById("customPromiseBtn")
                    .addEventListener("click", (e) => {
                         reset(true);
                         setActiveButton(e.currentTarget);
                    });
               document
                    .getElementById("asyncNoAwaitBtn")
                    .addEventListener("click", (e) => {
                         reset(true);
                         setActiveButton(e.currentTarget);
                    });
               document
                    .getElementById("asyncAwaitBtn")
                    .addEventListener("click", (e) => {
                         reset(true);
                         setActiveButton(e.currentTarget);
                    });
               document
                    .getElementById("resetBtn")
                    .addEventListener("click", () => {
                         reset(true);
                         setActiveButton(null);
                    });

               /* -------------------- Example runner (3 examples) -------------------- */
               function runExample1() {
                    exampleRunner("ex1");
               }
               function runExample2() {
                    exampleRunner("ex2");
               }
               function runExample3() {
                    exampleRunner("ex3");
               }

               ex1.addEventListener("click", runExample1);
               ex2.addEventListener("click", runExample2);
               ex3.addEventListener("click", runExample3);

               function exampleRunner(which) {
                    if (!activeTopic) {
                         log("Pick a topic first.");
                         speak("Pick a topic first.");
                         return;
                    }
                    log("Running", which, "for", activeTopic);
                    // pick small demo behaviour but also populate code area and prepare step-runner
                    const steps = getStepsForTopic(activeTopic, which);
                    populateCodeArea(steps);
                    // auto-run the steps in 'quick preview' mode
                    runSteps(steps, { auto: true, stepDelay: 500 }).then(() => {
                         log("Example finished.");
                         // show console (scroll into view)
                         consoleEl.scrollIntoView({
                              behavior: "smooth",
                              block: "end",
                         });
                    });
               }

               /* -------------------- Code / step runner -------------------- */
               let currentSteps = [];
               let runHandle = null;
               let currentIndex = -1;

               function populateCodeForTopic(topic) {
                    // loads a default example set for the topic so Run/Step buttons work
                    const steps = getStepsForTopic(topic, "ex1");
                    populateCodeArea(steps);
               }

               function populateCodeArea(steps) {
                    currentSteps = steps || [];
                    codeArea.innerHTML = "";
                    currentSteps.forEach((s, i) => {
                         const div = document.createElement("div");
                         div.className = "codeLine";
                         div.dataset.index = i;
                         div.textContent = i + 1 + ". " + s.code;
                         codeArea.appendChild(div);
                    });
                    currentIndex = -1;
               }

               async function runSteps(
                    steps,
                    opts = { auto: true, stepDelay: 500 }
               ) {
                    if (!steps || steps.length === 0) return;
                    runCodeBtn.disabled = true;
                    stepCodeBtn.disabled = true;
                    stopCodeBtn.disabled = false;
                    for (let i = 0; i < steps.length; i++) {
                         if (runHandle === "stopped") break;
                         currentIndex = i;
                         highlightLine(i);
                         await executeStep(steps[i]);
                         if (opts.auto) await pause(opts.stepDelay);
                    }
                    // cleanup
                    highlightLine(-1);
                    runCodeBtn.disabled = false;
                    stepCodeBtn.disabled = false;
                    stopCodeBtn.disabled = true;
                    runHandle = null;
                    // ensure console visible
                    consoleEl.scrollIntoView({
                         behavior: "smooth",
                         block: "end",
                    });
               }

               function pause(ms) {
                    return new Promise((res) => setTimeout(res, ms));
               }

               function highlightLine(i) {
                    Array.from(codeArea.children).forEach((c) =>
                         c.classList.remove("current")
                    );
                    if (i >= 0 && codeArea.children[i])
                         codeArea.children[i].classList.add("current");
               }

               async function executeStep(step) {
                    // step.op defines operation
                    log("> exec:", step.code);
                    switch (step.op) {
                         case "push":
                              pushStack(step.arg);
                              break;
                         case "pop":
                              popStack();
                              break;
                         case "webapiAdd":
                              addWebAPI(step.arg);
                              break;
                         case "webapiRemove":
                              removeWebAPI(step.arg);
                              break;
                         case "taskEnqueue":
                              enqueueTask(step.arg);
                              break;
                         case "taskDequeue":
                              {
                                   const t = dequeueTask();
                                   if (t) log("task dequeued:", t);
                              }
                              break;
                         case "microEnqueue":
                              enqueueMicro(step.arg);
                              break;
                         case "microDequeue":
                              {
                                   const m = dequeueMicro();
                                   if (m) log("micro dequeued:", m);
                              }
                              break;
                         case "log":
                              log(step.arg);
                              break;
                         case "speak":
                              speak(step.arg);
                              break;
                         default:
                              log("unknown op", step.op);
                              break;
                    }
               }

               runCodeBtn.addEventListener("click", () => {
                    if (currentSteps.length === 0) {
                         log("No code loaded. Select a topic or example.");
                         return;
                    }
                    runHandle = "running";
                    runSteps(currentSteps, { auto: true, stepDelay: 600 });
               });
               stepCodeBtn.addEventListener("click", async () => {
                    if (currentSteps.length === 0) {
                         log("No code loaded. Select a topic or example.");
                         return;
                    }
                    currentIndex++;
                    if (currentIndex >= currentSteps.length) {
                         log("End of code");
                         currentIndex = currentSteps.length - 1;
                         return;
                    }
                    highlightLine(currentIndex);
                    await executeStep(currentSteps[currentIndex]);
               });
               stopCodeBtn.addEventListener("click", () => {
                    runHandle = "stopped";
                    stopCodeBtn.disabled = true;
                    log("Run stopped");
                    highlightLine(-1);
                    runCodeBtn.disabled = false;
                    stepCodeBtn.disabled = false;
               });

               /* -------------------- Step definitions per topic (easier to read; functions defined) -------------------- */
               function getStepsForTopic(topic, which) {
                    if (!topic) return [];
                    // easier-to-read code snippets where functions are explicitly defined and then called
                    const map = {
                         "Callback Hell": [
                              {
                                   code: "function main() { setTimeout(callback, 50); }",
                                   op: "log",
                                   arg: "define main",
                              },
                              {
                                   code: "function callback() { console.log('done'); }",
                                   op: "log",
                                   arg: "define callback",
                              },
                              {
                                   code: "push global",
                                   op: "push",
                                   arg: "global",
                              },
                              {
                                   code: "push main()",
                                   op: "push",
                                   arg: "main()",
                              },
                              {
                                   code: "schedule timer for callback (webapi)",
                                   op: "webapiAdd",
                                   arg: "timer callback (50ms)",
                              },
                              { code: "unwind main (returns)", op: "pop" },
                              {
                                   code: "timer fires -> enqueue macrotask callback",
                                   op: "taskEnqueue",
                                   arg: "callback",
                              },
                              {
                                   code: "dequeue macrotask callback",
                                   op: "taskDequeue",
                              },
                              {
                                   code: "push callback",
                                   op: "push",
                                   arg: "callback",
                              },
                              {
                                   code: "callback runs -> pop callback",
                                   op: "pop",
                              },
                         ],
                         "Chained Promises": [
                              {
                                   code: "function doWork() { return Promise.resolve(1); }",
                                   op: "log",
                                   arg: "define doWork",
                              },
                              {
                                   code: "push global",
                                   op: "push",
                                   arg: "global",
                              },
                              { code: "push run()", op: "push", arg: "run()" },
                              {
                                   code: "call doWork() -> executor runs",
                                   op: "log",
                                   arg: "executor runs synchronously",
                              },
                              {
                                   code: "promise resolves -> enqueue microtask then1",
                                   op: "microEnqueue",
                                   arg: "then 1",
                              },
                              { code: "pop run()", op: "pop" },
                              {
                                   code: "microtask then1 runs",
                                   op: "microDequeue",
                              },
                              {
                                   code: "then1 schedules then2 -> enqueue microtask then2",
                                   op: "microEnqueue",
                                   arg: "then 2",
                              },
                              {
                                   code: "microtask then2 runs",
                                   op: "microDequeue",
                              },
                         ],
                         "Create Promise": [
                              {
                                   code: "function make() { return new Promise((res) => { setTimeout(()=>res('ok'), 70); }); }",
                                   op: "log",
                                   arg: "define make",
                              },
                              {
                                   code: "push global",
                                   op: "push",
                                   arg: "global",
                              },
                              {
                                   code: "push make()",
                                   op: "push",
                                   arg: "make()",
                              },
                              {
                                   code: "start IO -> webapi",
                                   op: "webapiAdd",
                                   arg: "io (70ms)",
                              },
                              {
                                   code: "unwind make (returns promise)",
                                   op: "pop",
                              },
                              {
                                   code: "io finishes -> remove webapi and enqueue microtask thenP",
                                   op: "webapiRemove",
                                   arg: "io (70ms)",
                              },
                              {
                                   code: "enqueue microtask thenP",
                                   op: "microEnqueue",
                                   arg: "thenP",
                              },
                              {
                                   code: "microtask thenP runs",
                                   op: "microDequeue",
                              },
                         ],
                         "async (no await)": [
                              {
                                   code: 'async function f() { console.log("sync inside"); return 42; }',
                                   op: "log",
                                   arg: "define f",
                              },
                              {
                                   code: "push global",
                                   op: "push",
                                   arg: "global",
                              },
                              {
                                   code: "push caller()",
                                   op: "push",
                                   arg: "caller()",
                              },
                              {
                                   code: "call f() -> runs sync part then returns Promise",
                                   op: "log",
                                   arg: "async returns promise",
                              },
                              {
                                   code: "then handler queued as microtask",
                                   op: "microEnqueue",
                                   arg: "f.then",
                              },
                              {
                                   code: "microtask f.then runs",
                                   op: "microDequeue",
                              },
                              { code: "pop caller()", op: "pop" },
                         ],
                         "async/await": [
                              {
                                   code: 'async function fetcher() { await delay(60); console.log("done"); }',
                                   op: "log",
                                   arg: "define fetcher",
                              },
                              {
                                   code: "push global",
                                   op: "push",
                                   arg: "global",
                              },
                              {
                                   code: "push caller()",
                                   op: "push",
                                   arg: "caller()",
                              },
                              {
                                   code: "call fetcher() -> push fetcher()",
                                   op: "push",
                                   arg: "fetcher()",
                              },
                              {
                                   code: "fetcher calls delay -> webapi",
                                   op: "webapiAdd",
                                   arg: "delay(60ms)",
                              },
                              {
                                   code: "fetcher hits await -> pop fetcher (paused)",
                                   op: "pop",
                              },
                              {
                                   code: "delay finishes -> remove webapi and enqueue microtask afterAwait",
                                   op: "webapiRemove",
                                   arg: "delay(60ms)",
                              },
                              {
                                   code: "enqueue microtask afterAwait",
                                   op: "microEnqueue",
                                   arg: "afterAwait",
                              },
                              {
                                   code: "microtask afterAwait runs (resume fetcher)",
                                   op: "microDequeue",
                              },
                              {
                                   code: "resume fetcher, pop",
                                   op: "log",
                                   arg: "fetcher resumed",
                              },
                         ],
                    };
                    return map[topic] || [];
               }

               /* -------------------- Run/step control (already wired) -------------------- */
               runCodeBtn.disabled = false;
               stepCodeBtn.disabled = false;
               stopCodeBtn.disabled = true;

               /* -------------------- Console quick facts -------------------- */
               consoleEl.addEventListener("dblclick", () => {
                    alert(`Quick facts:
- Call Stack: functions execute LIFO.
- Web APIs: timers/fetch run outside the stack.
- Microtasks: Promise.then run before next macrotask.
- textContent vs innerText vs innerHTML: use textContent to include hidden elements.`);
               });

               log(
                    "Hitman 47 ready. Select a topic then Example 1/2/3 or use Run/Step to execute code lines."
               );
          </script>
     </body>
</html>
